<!DOCTYPE html>
<html>
<head>
  <title>ระบบออกเลขหนังสือ</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body, .swal2-title, .swal2-content, .swal2-confirm {
      font-family: 'Prompt', sans-serif !important;
    }
    
    #submitBtn {
      transition: all 0.3s ease;
    }
    
    #submitBtn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .retry-info {
      font-size: 0.9em;
      color: #6c757d;
      margin-top: 10px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container mt-5">
    <h2 class="text-center"><ลงทะเบียนออกเลขหนังสือ อว></h2>
    <form id="bookForm" class="needs-validation" novalidate>
      <div class="mb-3">
        <label for="date" class="form-label">ลงวันที่</label>
        <input type="date" class="form-control" id="date" required>
      </div>
      <div class="mb-3">
        <label for="from" class="form-label">จาก</label>
        <input list="fromOptions" class="form-control" id="from" placeholder="-พิมพ์หรือเลือกผู้ส่ง-" required>
        <datalist id="fromOptions"></datalist>
      </div>
      <div class="mb-3">
        <label for="to" class="form-label">ถึง</label>
        <input list="sentOptions" class="form-control" id="to" placeholder="-พิมพ์หรือเลือกผู้รับ-" required>
        <datalist id="sentOptions"></datalist>
      </div>
      <div class="mb-3">
        <label for="subject" class="form-label">เรื่อง</label>
        <input type="text" class="form-control" id="subject" placeholder="-ชื่อเรื่อง-"required>
        <datalist id="sentSSOptions"></datalist>
      </div>
      <div class="mb-3">
        <label for="action" class="form-label">การปฏิบัติ</label>
        <input type="text" class="form-control" id="action" placeholder="-ลงชื่อผู้รับผิดชอบ-" required>
      </div>
      <button type="button" class="btn btn-primary w-100" id="submitBtn" onclick="submitForm()">ออกเลขบันทึกข้อความ</button>
      <div class="retry-info" id="retryInfo" style="display: none;">
        <small><i class="fas fa-info-circle"></i> หากระบบแจ้งให้ลองใหม่ กรุณารอสักครู่แล้วกดปุ่มอีกครั้ง</small>
      </div>
    </form>
  </div>

  <script>
    let isSubmitting = false;
    let retryCount = 0;
    const maxRetries = 3;

    document.addEventListener('DOMContentLoaded', function () {
      // Load options for "จาก" (from) field
      google.script.run.withSuccessHandler(populateFromOptions).getFromOptions();
      // Load options for "ถึง" (to) field
      google.script.run.withSuccessHandler(populateSentOptions).getSentOptions();
    });

    function populateFromOptions(options) {
      const dataList = document.getElementById('fromOptions');
      options.forEach(option => {
        const opt = document.createElement('option');
        opt.value = option;
        dataList.appendChild(opt);
      });
    }

    function populateSentOptions(options) {
      const dataList = document.getElementById('sentOptions');
      options.forEach(option => {
        const opt = document.createElement('option');
        opt.value = option;
        dataList.appendChild(opt);
      });
    }

    function submitForm() {
      const form = document.getElementById('bookForm');
      const submitBtn = document.getElementById('submitBtn');
      const retryInfo = document.getElementById('retryInfo');

      if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
      }

      // ป้องกันการกดซ้ำ
      if (isSubmitting) {
        Swal.fire({
          title: 'กรุณารอสักครู่',
          text: 'ระบบกำลังประมวลผลคำขอของคุณ',
          icon: 'info',
          timer: 2000,
          showConfirmButton: false
        });
        return;
      }

      isSubmitting = true;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>กำลังออกเลข...';

      const data = {
        date: document.getElementById('date').value,
        from: document.getElementById('from').value,
        to: document.getElementById('to').value,
        subject: document.getElementById('subject').value,
        action: document.getElementById('action').value
      };

      Swal.fire({
        title: 'กำลังออกเลข',
        text: 'กรุณารอสักครู่...',
        didOpen: () => Swal.showLoading(),
        allowOutsideClick: false,
        allowEscapeKey: false
      });

      google.script.run
        .withSuccessHandler(handleSuccess)
        .withFailureHandler(handleError)
        .saveData(data);
    }

    function handleSuccess(result) {
      isSubmitting = false;
      const submitBtn = document.getElementById('submitBtn');
      const retryInfo = document.getElementById('retryInfo');
      
      submitBtn.disabled = false;
      submitBtn.innerHTML = 'ออกเลขบันทึกข้อความ';

      if (result.success) {
        // สำเร็จ - แสดงเลขที่ได้
        retryCount = 0;
        retryInfo.style.display = 'none';
        
        Swal.fire({
          title: 'สำเร็จ!',
          text: `เลขบันทึกของคุณคือ ที่ อว 67.06.2/ ${result.number}`,
          icon: 'success',
          confirmButtonText: 'ตกลง',
          timer: 10000
        });

        // รีเซ็ตฟอร์ม
        const form = document.getElementById('bookForm');
        form.reset();
        document.getElementById('from').value = '';
        document.getElementById('action').value = 'งานธุรการ';
        form.classList.remove('was-validated');

      } else {
        // ไม่สำเร็จ - แสดงข้อความข้อผิดพลาดและเสนอให้ลองใหม่
        retryCount++;
        
        if (retryCount < maxRetries) {
          retryInfo.style.display = 'block';
          
          Swal.fire({
            title: 'ไม่สามารถออกเลขได้',
            text: result.message + ` (ครั้งที่ ${retryCount}/${maxRetries})`,
            icon: 'warning',
            confirmButtonText: 'ลองใหม่อีกครั้ง',
            cancelButtonText: 'ยกเลิก',
            showCancelButton: true,
            timer: 8000
          }).then((result) => {
            if (result.isConfirmed) {
              // รอสักครู่แล้วลองใหม่อัตโนมัติ
              setTimeout(() => {
                submitForm();
              }, 1000 + Math.random() * 2000); // รอ 1-3 วินาที
            }
          });
        } else {
          // ลองครบแล้ว
          retryCount = 0;
          retryInfo.style.display = 'none';
          
          Swal.fire({
            title: 'ไม่สามารถออกเลขได้',
            text: 'ลองหลายครั้งแล้วไม่สำเร็จ กรุณาติดต่อผู้ดูแลระบบหรือลองใหม่ในภายหลัง',
            icon: 'error',
            confirmButtonText: 'ตกลง'
          });
        }
      }
    }

    function handleError(error) {
      isSubmitting = false;
      const submitBtn = document.getElementById('submitBtn');
      
      submitBtn.disabled = false;
      submitBtn.innerHTML = 'ออกเลขบันทึกข้อความ';

      console.error('Error:', error);
      
      Swal.fire({
        title: 'เกิดข้อผิดพลาด',
        text: 'ไม่สามารถเชื่อมต่อกับระบบได้ กรุณาลองใหม่อีกครั้ง',
        icon: 'error',
        confirmButtonText: 'ตกลง'
      });
    }

    // เพิ่มการจัดการเมื่อผู้ใช้ปิดหน้าต่างระหว่างประมวลผล
    window.addEventListener('beforeunload', function(e) {
      if (isSubmitting) {
        e.preventDefault();
        e.returnValue = 'ระบบกำลังประมวลผลคำขอของคุณ หากปิดหน้าต่างอาจทำให้ข้อมูลสูญหาย';
        return e.returnValue;
      }
    });
  </script>
</body>
</html>